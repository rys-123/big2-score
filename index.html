<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>â™ ï¸ é”„å¤§åœ°è®¡åˆ†å™¨</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" href="./icon-192.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root {
            --primary: #007bff;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --dark: #343a40;
            --light: #f8f9fa;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: #f2f4f7;
            color: #333;
            padding-bottom: calc(75px + var(--safe-bottom)); 
            padding-top: env(safe-area-inset-top, 0px);
        }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            background: #fff;
            padding: 12px 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        h1 { margin: 0; font-size: 1.15rem; font-weight: 800; color: #2c3e50; }
        .header-btns { display: flex; gap: 12px; }
        .icon-btn {
            background: #f1f3f5; border: none; font-size: 1.1rem; 
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }

        /* è­¦å‘Šæ¡ - æ¸¸æˆç»“æŸ */
        #alert-banner {
            background-color: #ffe3e3;
            color: #c92a2a;
            border-bottom: 1px solid #ffc9c9;
            text-align: center;
            padding: 12px;
            font-size: 0.95rem;
            font-weight: bold;
            display: none;
            line-height: 1.5;
            animation: fadeIn 0.5s;
        }

        /* è®¡åˆ†æ¿åŒºåŸŸ */
        .scoreboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 12px;
            background: #fff;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .player-card {
            text-align: center;
            padding: 10px 4px;
            border-radius: 12px;
            background: #f8f9fa;
            border: 2px solid transparent;
            transition: all 0.3s;
            position: relative;
        }
        .player-card.loser {
            background-color: #fff0f0;
            border-color: var(--danger);
        }
        .status-icon {
            display: none; position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            font-size: 18px; background: #fff; border-radius: 50%; padding: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 2;
        }
        .player-card.loser .status-icon { display: block; }

        .player-name-input {
            width: 100%; border: none; background: transparent;
            text-align: center; font-weight: 600; font-size: 0.9rem;
            margin-bottom: 6px; color: #495057; padding: 4px 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .player-score {
            font-size: 1.6rem; font-weight: 800; color: var(--primary);
            font-family: "DIN Alternate", "Roboto Condensed", sans-serif;
            cursor: default; /* é»˜è®¤ä¸å¯ç‚¹å‡» */
            position: relative;
        }
        /* å½“å…è®¸ç¼–è¾‘æ—¶æ˜¾ç¤ºä¸ºæ‰‹å‹ */
        .player-score.editable {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-decoration-color: #ccc;
            text-underline-offset: 4px;
        }
        .player-score.danger { color: var(--danger); }
        
        /* æ“ä½œæŒ‰é’®åŒº */
        .action-area { padding: 10px 20px; text-align: center; }
        .btn-main {
            width: 100%; max-width: 400px; padding: 16px;
            font-size: 1.15rem; background: linear-gradient(135deg, #007bff, #0056b3);
            color: white; border: none; border-radius: 16px; font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,123,255,0.4); cursor: pointer;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main.disabled {
            background: #adb5bd; pointer-events: none; box-shadow: none; opacity: 0.8;
        }

        /* å†å²è®°å½•åŒº */
        .history-section {
            background: #fff; margin: 10px 15px; border-radius: 16px;
            padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .history-title {
            font-size: 0.95rem; color: #333; margin-bottom: 12px; font-weight: 700;
            display: flex; justify-content: space-between; align-items: center;
        }
        .history-list {
            max-height: 30vh; overflow-y: auto; font-size: 0.9rem;
            -webkit-overflow-scrolling: touch;
        }
        .history-row {
            display: grid; grid-template-columns: 0.8fr repeat(4, 1fr);
            padding: 10px 0; border-bottom: 1px solid #f1f3f5; text-align: center; align-items: center;
        }
        .history-header {
            font-weight: bold; background: #f8f9fa; border-radius: 8px; color: #666; font-size: 0.8rem; padding: 8px 0;
        }
        .round-idx { color: #adb5bd; font-size: 0.75rem; }
        .score-change { font-weight: 600; color: #333; }
        .score-winner { font-size: 1.2rem; line-height: 1; } 

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 1000;
            justify-content: center; align-items: center; padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #fff; width: 100%; max-width: 450px; border-radius: 24px;
            padding: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: zoomIn 0.2s ease-out; max-height: 85vh; overflow-y: auto;
        }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .input-row {
            display: flex; align-items: center; margin-bottom: 16px; 
            background: #f8f9fa; padding: 8px; border-radius: 12px;
        }
        .input-label { width: 70px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .input-group { flex: 1; display: flex; align-items: center; gap: 8px; }
        
        input[type="number"] {
            flex: 1; padding: 12px; border: 2px solid transparent; background: #fff;
            border-radius: 8px; font-size: 18px; font-weight: bold; text-align: center;
        }
        input[type="number"]:focus { border-color: var(--primary); outline: none; }
        
        .twos-selector { display: flex; gap: 6px; align-items: center; margin-left: 5px;}
        .twos-label { font-size: 0.8rem; color: #888; font-weight: bold; }
        .twos-btn {
            width: 34px; height: 34px; border-radius: 50%; 
            border: 1px solid #dee2e6; background: #fff;
            display: flex; justify-content: center; align-items: center; 
            font-size: 0.9rem; font-weight: bold; color: #495057; cursor: pointer;
        }
        .twos-btn.selected { 
            background: var(--danger); color: white; border-color: var(--danger); 
            box-shadow: 0 2px 6px rgba(220,53,69,0.4);
        }
        .hidden { display: none !important; }

        .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
        .btn-cancel, .btn-confirm {
            padding: 14px; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; flex: 1;
        }
        .btn-cancel { background: #f1f3f5; color: #495057; }
        .btn-confirm { background: var(--success); color: white; flex: 1.5; }

        /* åº•éƒ¨å·¥å…·æ  */
        .footer-tools {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05); padding: 8px 0;
            padding-bottom: env(safe-area-inset-bottom, 10px); 
            display: flex; justify-content: space-around; z-index: 900;
        }
        .btn-tool {
            background: none; border: none; color: #6c757d; font-size: 0.7rem;
            display: flex; flex-direction: column; align-items: center; gap: 4px; width: 50%;
        }
        .btn-tool svg { width: 24px; height: 24px; fill: currentColor; opacity: 0.8; }

        /* è®¾ç½®ä¸å¸®åŠ© */
        .rule-block { background: #f8f9fa; padding: 12px; border-radius: 10px; margin-bottom: 12px; font-size: 0.9rem; line-height: 1.6; color: #555; }
        .rule-block strong { color: var(--primary); display:block; margin-bottom:4px;}
        .switch-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px dashed #eee; }
        
        .switch { position: relative; display: inline-block; width: 50px; height: 30px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e9ecef; transition: .3s; border-radius: 30px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        .setting-input-wrapper { display:flex; align-items:center; gap:5px; }
        .setting-input { width:80px; padding:6px; text-align:center; border:1px solid #ddd; border-radius:6px; font-size:16px; font-weight:bold; }

        /* å…³äºä¿¡æ¯åŒºåŸŸ */
        .about-footer {
            margin-top: 20px; padding-top: 20px; border-top: 1px dashed #ddd; text-align: center;
        }
        .about-qr {
            width: 120px; height: 120px; margin: 10px auto; border-radius: 8px; border: 1px solid #eee; padding: 5px; background: #fff;
            display: block;
        }

    </style>
</head>
<body>

<header>
    <h1>â™ ï¸ é”„å¤§åœ°è®°åˆ†å™¨</h1>
    <div class="header-btns">
        <button class="icon-btn" id="btn-help" title="è§„åˆ™è¯´æ˜">â“</button>
        <button class="icon-btn" id="btn-settings" title="è®¾ç½®">âš™ï¸</button>
    </div>
</header>

<div id="alert-banner"></div>

<!-- è®¡åˆ†æ¿ -->
<div class="scoreboard" id="scoreboard">
    <!-- åŠ¨æ€ç”Ÿæˆ -->
</div>

<!-- æ“ä½œåŒº -->
<div class="action-area">
    <button class="btn-main" id="btn-record">ğŸ“ è®°ä¸€å±€</button>
</div>

<!-- å†å²è®°å½• -->
<div class="history-section">
    <div class="history-title">
        <span>ğŸ“‹ å•å±€æ˜ç»†</span>
        <small id="round-count" style="color:#999; font-weight:normal">å…± 0 å±€</small>
    </div>
    <div class="history-list" id="history-list">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>

<!-- åº•éƒ¨å·¥å…·æ  -->
<div class="footer-tools">
    <button class="btn-tool" id="btn-restart">
        <svg viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
        <span>æ–°çš„ä¸€ç›˜</span>
    </button>
    <button class="btn-tool" id="btn-reset-all" style="color: var(--danger);">
        <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
        <span>é‡ç½®æ•°æ®</span>
    </button>
</div>

<!-- è®°åˆ†å¼¹çª— (Modal) -->
<div class="modal" id="score-modal">
    <div class="modal-content">
        <h3 style="margin-top:0; text-align:center;">è¾“å…¥å‰©ä½™ç‰Œæ•°</h3>
        <div id="modal-inputs">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" id="modal-cancel">å–æ¶ˆ</button>
            <button class="btn-confirm" id="modal-confirm">ç¡®è®¤è®¡ç®—</button>
        </div>
    </div>
</div>

<!-- è®¾ç½®å¼¹çª— -->
<div class="modal" id="settings-modal">
    <div class="modal-content">
        <h3>è®¾ç½®</h3>
        
        <!-- è®¾ç½®é¡¹1: ç»“æŸåˆ†æ•°çº¿ -->
        <div class="switch-row">
            <div>
                <div style="font-weight:bold; font-size:1rem;">æœ¬ç›˜ç»“æŸåˆ†æ•°çº¿</div>
                <div style="font-size:0.85rem; color:#888; margin-top:4px;">
                    ä»»æ„ç©å®¶è¾¾åˆ°æ­¤åˆ†æ•°æ—¶æ¸¸æˆç»“æŸã€‚
                </div>
            </div>
            <div class="setting-input-wrapper">
                <input type="number" id="max-score-input" class="setting-input" value="100">
                <span style="font-size:0.8rem; font-weight:bold; color:#666">åˆ†</span>
            </div>
        </div>

        <!-- è®¾ç½®é¡¹2: 2çš„åŠ ç½š -->
        <div class="switch-row">
            <div>
                <div style="font-weight:bold; font-size:1rem;">å¯ç”¨"2"çš„åŠ ç½šè§„åˆ™</div>
                <div style="font-size:0.85rem; color:#888; margin-top:4px;">
                    å½“æœ‰äººå‡ºå®Œç‰Œæ—¶ï¼Œå…¶ä½™ç©å®¶æ‰‹é‡Œçš„2éœ€é¢å¤–ç½šåˆ†ã€‚
                </div>
            </div>
            <label class="switch">
                <input type="checkbox" id="rule5-toggle">
                <span class="slider"></span>
            </label>
        </div>

        <!-- è®¾ç½®é¡¹3: æ‰‹åŠ¨ä¿®æ”¹åˆ†æ•° -->
        <div class="switch-row">
            <div>
                <div style="font-weight:bold; font-size:1rem;">å…è®¸æ‰‹åŠ¨ä¿®æ”¹åˆ†æ•°</div>
                <div style="font-size:0.85rem; color:#888; margin-top:4px;">
                    å¼€å¯åï¼Œç‚¹å‡»é¦–é¡µç©å®¶åˆ†æ•°å¯ç›´æ¥ä¿®æ­£æ•°å€¼ã€‚
                </div>
            </div>
            <label class="switch">
                <input type="checkbox" id="edit-score-toggle">
                <span class="slider"></span>
            </label>
        </div>

        <div style="margin-top:20px;">
            <button class="btn-confirm" onclick="document.getElementById('settings-modal').classList.remove('active')" style="width:100%">å®Œæˆ</button>
        </div>
    </div>
</div>

<!-- å¸®åŠ©å¼¹çª— -->
<div class="modal" id="help-modal">
    <div class="modal-content">
        <h3>è§„åˆ™ä¸è¯´æ˜</h3>
        <div class="rule-block">
            <strong>1. åŸºç¡€è®¡åˆ† (ç½šåˆ†åˆ¶)</strong>
            â€¢ å‰©ä½™ < 8 å¼  : 1å€ (nåˆ†)<br>
            â€¢ 8 â‰¤ å‰©ä½™ < 10 : 2å€ (2nåˆ†)<br>
            â€¢ 10 â‰¤ å‰©ä½™ < 13 : 3å€ (3nåˆ†)<br>
            â€¢ å‰©ä½™ 13 å¼  : 4å€ (52åˆ†)
        </div>
        <div class="rule-block">
            <strong>2. ç‰¹æ®Šè§„åˆ™ ("2"çš„åŠ ç½š)</strong>
            è‹¥å¼€å¯ï¼ˆé»˜è®¤ä¸ºå…³é—­ï¼‰ï¼Œå½“ä¸€å®¶å‡ºå®Œç‰Œæ—¶ï¼Œå…¶ä½™ç©å®¶æ‰‹é‡Œæ¯æœ‰ä¸€å¼ 2ï¼Œç½šåˆ†åœ¨åŸåŸºç¡€ä¸Š <strong>+10åˆ†</strong>ã€‚
        </div>
        <div class="rule-block">
            <strong>3. è¾“èµ¢åˆ¤å®š</strong>
            â€¢ 0åˆ†ä¸ºå½“å±€ä¼˜èƒœ(ğŸ‘‘)ã€‚<br>
            â€¢ ä»»æ„ç©å®¶æ€»åˆ† <strong>â‰¥è®¾å®šåˆ†æ•°çº¿ (é»˜è®¤100)</strong> æ—¶ï¼Œæœ¬ç›˜ç»“æŸã€‚<br>
            â€¢ æ‰€æœ‰åˆ†æ•°è¶…è¿‡è¯¥çº¿çš„ç©å®¶å‡ä¸ºè¾“å®¶(ğŸ’¸)ã€‚
        </div>
        <div class="rule-block">
            <strong>4. æ“ä½œæŒ‡å—</strong>
            â€¢ <strong>ä¿®æ”¹åå­—</strong>ï¼šç‚¹å‡»é¦–é¡µç©å®¶åç§°å³å¯ä¿®æ”¹ã€‚<br>
            â€¢ <strong>ä¿®æ”¹åˆ†æ•°</strong>ï¼šåœ¨è®¾ç½®ä¸­å¼€å¯â€œå…è®¸æ‰‹åŠ¨ä¿®æ”¹åˆ†æ•°â€åï¼Œç‚¹å‡»é¦–é¡µç©å®¶åˆ†æ•°å¯è¿›è¡Œä¿®æ­£ï¼ˆä»…é™æ­£æ•´æ•°ï¼‰ã€‚<br>
            â€¢ <strong>è®°åˆ†</strong>ï¼šç‚¹å‡»â€œè®°ä¸€å±€â€ï¼Œè¾“å…¥å‰©ä½™å¼ æ•°ã€‚è‹¥æœ‰2ä¸”å¼€å¯äº†åŠ ç½šï¼Œç‚¹å‡»ä¸‹æ–¹æ•°å­—é€‰æ‹©ã€‚<br>
            â€¢ <strong>å®‰è£…APP</strong>ï¼šiPhoneè¯·åœ¨Safariç‚¹å‡»åˆ†äº«->æ·»åŠ åˆ°ä¸»å±å¹•ï¼›å®‰å“è¯·åœ¨Chromeèœå•ç‚¹å‡»å®‰è£…åº”ç”¨ã€‚<br>
        </div>
        
        <!-- å¢åŠ åˆ¶ä½œäººä¸äºŒç»´ç  -->
        <div class="about-footer">
            <div style="font-weight:bold; color:#333; margin-bottom:5px;">åˆ¶ä½œäººï¼šRYS</div>
            <img id="page-qr" src="" alt="Scan QR" class="about-qr">
            <div style="font-size:0.75rem; color:#999;">æ‰«ç å®‰è£…åˆ°æ‰‹æœº</div>
        </div>

        <div style="margin-top:20px;">
            <button class="btn-confirm" onclick="document.getElementById('help-modal').classList.remove('active')" style="width:100%">å…³é—­</button>
        </div>
    </div>
</div>

<script>
    // --- çŠ¶æ€ç®¡ç† ---
    // å‡çº§KEYç‰ˆæœ¬ä»¥ç¡®ä¿æ–°é»˜è®¤å€¼ç”Ÿæ•ˆ (æˆ–åœ¨loadStateä¸­åšåˆå¹¶)
    const STORAGE_KEY = 'big2_score_data_v7'; 
    
    const defaultState = {
        players: [
            { id: 0, name: "ç©å®¶A", score: 0 },
            { id: 1, name: "ç©å®¶B", score: 0 },
            { id: 2, name: "ç©å®¶C", score: 0 },
            { id: 3, name: "ç©å®¶D", score: 0 }
        ],
        history: [], 
        settings: {
            enableTwos: false, // ä¿®æ”¹ï¼šé»˜è®¤å…³é—­
            maxScore: 100,     // æ–°å¢ï¼šé»˜è®¤100åˆ†
            allowScoreEdit: false // æ–°å¢ï¼šé»˜è®¤å…³é—­
        }
    };

    let appState = loadState();

    function loadState() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                // ç®€å•çš„åˆå¹¶é€»è¾‘ï¼Œé˜²æ­¢æ—§ç‰ˆæœ¬ç¼ºå°‘æ–°å­—æ®µ
                if (!parsed.history) parsed.history = [];
                if (!parsed.settings) parsed.settings = {};
                // å°†é»˜è®¤è®¾ç½®ä¸ä¿å­˜çš„è®¾ç½®åˆå¹¶ï¼Œç¡®ä¿æ–°å­—æ®µå­˜åœ¨
                parsed.settings = { ...defaultState.settings, ...parsed.settings };
                return parsed;
            }
        } catch(e) { console.error("Load failed", e); }
        return JSON.parse(JSON.stringify(defaultState));
    }

    function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
        render();
    }

    function calculatePenalty(cards, twoCount) {
        if (cards === 0) return 0;
        
        let score = cards; 
        if (cards >= 8 && cards < 10) score = cards * 2;
        else if (cards >= 10 && cards < 13) score = cards * 3;
        else if (cards === 13) score = cards * 4; 

        if (appState.settings.enableTwos && twoCount > 0) {
            score += (twoCount * 10);
        }
        return score;
    }

    // --- æ¸²æŸ“é€»è¾‘ ---

    const ui = {
        scoreboard: document.getElementById('scoreboard'),
        alertBanner: document.getElementById('alert-banner'),
        btnRecord: document.getElementById('btn-record'),
        modal: document.getElementById('score-modal'),
        modalInputs: document.getElementById('modal-inputs'),
        rule5Toggle: document.getElementById('rule5-toggle'),
        editScoreToggle: document.getElementById('edit-score-toggle'), // æ–°å¢
        maxScoreInput: document.getElementById('max-score-input'), // æ–°å¢
        historyList: document.getElementById('history-list'),
        roundCount: document.getElementById('round-count')
    };

    function render() {
        ui.scoreboard.innerHTML = '';
        
        // ä½¿ç”¨åŠ¨æ€è®¾ç½®çš„åˆ†æ•°çº¿ï¼Œé»˜è®¤ä¸º100
        const limit = appState.settings.maxScore || 100;
        const losers = appState.players.filter(p => p.score >= limit);
        const isGameOver = losers.length > 0;
        
        if (isGameOver) {
            const loserNames = losers.map(p => p.name).join('ã€');
            ui.alertBanner.innerHTML = `ğŸš¨ <strong>è®¡åˆ†ç»“æŸï¼</strong><br>æœ¬ç›˜æœ‰ç©å®¶åˆ†æ•°è¾¾åˆ° ${limit} åˆ†äº†ï¼š<br><span style="font-size:1.1rem;color:#c92a2a">${loserNames}</span>`;
            ui.alertBanner.style.display = 'block';
            
            ui.btnRecord.classList.add('disabled');
            ui.btnRecord.innerHTML = 'ğŸš« æœ¬ç›˜ç»“æŸ (è¯·å¼€å¯æ–°çš„ä¸€ç›˜)';
        } else {
            ui.alertBanner.style.display = 'none';
            ui.btnRecord.classList.remove('disabled');
            ui.btnRecord.innerHTML = 'ğŸ“ è®°ä¸€å±€';
        }

        appState.players.forEach((player, index) => {
            const isLoser = player.score >= limit;
            const div = document.createElement('div');
            div.className = `player-card ${isLoser ? 'loser' : ''}`;
            
            // æ£€æŸ¥æ˜¯å¦å…è®¸æ‰‹åŠ¨æ”¹åˆ†
            const editableClass = appState.settings.allowScoreEdit ? 'editable' : '';
            const titleAttr = appState.settings.allowScoreEdit ? 'title="ç‚¹å‡»ä¿®æ”¹åˆ†æ•°"' : '';
            
            div.innerHTML = `
                <div class="status-icon">ğŸ’¸</div>
                <input type="text" class="player-name-input" data-idx="${index}" value="${player.name}" onfocus="this.select()" placeholder="ç‚¹å‡»è¾“å…¥">
                <div class="player-score ${isLoser ? 'danger' : ''} ${editableClass}" ${titleAttr}>${player.score}</div>
            `;
            
            // ç»‘å®šç‚¹å‡»ä¿®æ”¹äº‹ä»¶
            if (appState.settings.allowScoreEdit) {
                const scoreDiv = div.querySelector('.player-score');
                scoreDiv.addEventListener('click', () => handleScoreEdit(index));
            }

            ui.scoreboard.appendChild(div);
        });

        document.querySelectorAll('.player-name-input').forEach(input => {
            input.addEventListener('change', (e) => {
                const idx = parseInt(e.target.dataset.idx);
                appState.players[idx].name = e.target.value || `ç©å®¶${String.fromCharCode(65+idx)}`;
                saveState();
            });
        });

        renderHistory();
        
        // åŒæ­¥è®¾ç½®é¢æ¿çŠ¶æ€
        ui.rule5Toggle.checked = appState.settings.enableTwos;
        ui.editScoreToggle.checked = appState.settings.allowScoreEdit;
        ui.maxScoreInput.value = appState.settings.maxScore;
    }

    function renderHistory() {
        const history = appState.history;
        ui.roundCount.textContent = `å…± ${history.length} å±€`;
        
        if (history.length === 0) {
            ui.historyList.innerHTML = '<div style="text-align:center;padding:20px;color:#ccc;">æš‚æ— è®°å½•ï¼Œå¿«å¼€å§‹ç¬¬ä¸€å±€å§~</div>';
            return;
        }

        let html = `
            <div class="history-row history-header">
                <div class="round-idx">#</div>
                ${appState.players.map(p => `<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${p.name.substring(0,4)}</div>`).join('')}
            </div>
        `;

        [...history].reverse().forEach((record, revIdx) => {
            const realIdx = history.length - revIdx;
            let rowHtml = `<div class="history-row">
                <div class="round-idx">${realIdx}</div>`;
            
            record.scores.forEach(s => {
                if (s.points === 0) {
                    rowHtml += `<div class="score-change score-winner">ğŸ‘‘</div>`;
                } else {
                    let detail = '';
                    if(s.twos > 0) detail = `<sub style="font-size:0.6em;color:var(--danger)">+${s.twos}å¼ 2</sub>`;
                    rowHtml += `<div class="score-change">+${s.points}${detail}</div>`;
                }
            });
            
            rowHtml += `</div>`;
            html += rowHtml;
        });

        ui.historyList.innerHTML = html;
    }

    // --- äº¤äº’ä¸æ ¡éªŒ ---
    
    // æ‰‹åŠ¨ä¿®æ”¹åˆ†æ•°é€»è¾‘
    function handleScoreEdit(index) {
        if (!appState.settings.allowScoreEdit) return;
        
        const currentPlayer = appState.players[index];
        const input = prompt(`ä¿®æ”¹ ${currentPlayer.name} çš„åˆ†æ•°\nè¯·è¾“å…¥æ–°çš„åˆ†æ•°ï¼ˆåªèƒ½æ˜¯0æˆ–æ­£æ•´æ•°ï¼‰:`, currentPlayer.score);
        
        if (input !== null) {
            // éªŒè¯æ˜¯å¦ä¸ºéè´Ÿæ•´æ•°
            if (/^\d+$/.test(input)) {
                const newScore = parseInt(input, 10);
                currentPlayer.score = newScore;
                saveState();
                // è®°å½•ä¸€æ¡ä¿®æ”¹æ—¥å¿—ï¼ˆå¯é€‰ï¼Œç›®å‰æš‚ä¸è®°å½•åˆ°historyä»¥å…æ··ä¹±ï¼Œç›´æ¥æ”¹å½“å‰åˆ†ï¼‰
            } else {
                alert("âŒ è¾“å…¥æ— æ•ˆï¼è¯·è¾“å…¥åˆæ³•çš„æ­£æ•´æ•°ï¼ˆåŒ…æ‹¬0ï¼‰ã€‚");
            }
        }
    }

    function openModal() {
        if (ui.btnRecord.classList.contains('disabled')) return;

        ui.modalInputs.innerHTML = '';
        appState.players.forEach((player, index) => {
            const row = document.createElement('div');
            row.className = 'input-row';
            
            let twosHtml = '';
            // å³ä½¿å…³é—­äº†enableTwosï¼Œç”Ÿæˆé€»è¾‘è¿˜åœ¨ï¼Œåªæ˜¯ä¸æ˜¾ç¤ºï¼Œ
            // ä½†ä¸ºäº†å®‰å…¨èµ·è§ï¼Œå¦‚æœä¸å¯ç”¨ï¼Œè¿™é‡Œä¹Ÿä¸ç”ŸæˆHTMLç»“æ„ï¼Œæˆ–è€…ä¿æŒéšè—
            // æ ¹æ®é€»è¾‘calculatePenaltyï¼Œå¦‚æœä¸å¯ç”¨ï¼ŒtwoCountä¼ ä»€ä¹ˆéƒ½æ²¡ç”¨ã€‚
            // è¿™é‡Œä¸ºäº†UIä¸€è‡´æ€§ï¼Œå¦‚æœenableTwosä¸ºfalseï¼Œç›´æ¥ä¸æ¸²æŸ“selector
            if (appState.settings.enableTwos) {
                twosHtml = `
                    <div class="twos-selector hidden" id="twos-group-${index}">
                        <span class="twos-label">2:</span>
                        ${[1,2,3,4].map(n => `<div class="twos-btn" onclick="selectTwos(${index}, ${n}, this)">${n}</div>`).join('')}
                        <input type="hidden" id="twos-val-${index}" value="0">
                    </div>
                `;
            } else {
                // å ä½éšè—inputé˜²æ­¢æŠ¥é”™
                twosHtml = `<input type="hidden" id="twos-val-${index}" value="0">`;
            }

            row.innerHTML = `
                <div class="input-label">${player.name}</div>
                <div class="input-group">
                    <input type="number" id="card-input-${index}" placeholder="0" inputmode="numeric" oninput="handleCardInput(${index}, this)">
                    ${twosHtml}
                </div>
            `;
            ui.modalInputs.appendChild(row);
        });
        ui.modal.classList.add('active');
    }

    function closeModal() {
        ui.modal.classList.remove('active');
    }

    window.handleCardInput = function(index, input) {
        let val = parseInt(input.value);
        if (isNaN(val)) val = 0;
        if (val > 13) { input.value = 13; val = 13; }
        if (val < 0) { input.value = ''; val = 0; }

        if (appState.settings.enableTwos) {
            const twosGroup = document.getElementById(`twos-group-${index}`);
            if (twosGroup && !twosGroup.classList.contains('hidden-by-setting')) { // å¢åŠ å®‰å…¨æ€§åˆ¤æ–­
                if (val > 0) {
                    twosGroup.classList.remove('hidden');
                } else {
                    twosGroup.classList.add('hidden');
                    document.getElementById(`twos-val-${index}`).value = 0;
                    twosGroup.querySelectorAll('.twos-btn').forEach(b => b.classList.remove('selected'));
                }
            }
        }
    };

    window.selectTwos = function(index, count, btnElement) {
        const parent = document.getElementById(`twos-group-${index}`);
        const hiddenInput = document.getElementById(`twos-val-${index}`);
        if (btnElement.classList.contains('selected')) {
            btnElement.classList.remove('selected');
            hiddenInput.value = 0;
        } else {
            parent.querySelectorAll('.twos-btn').forEach(b => b.classList.remove('selected'));
            btnElement.classList.add('selected');
            hiddenInput.value = count;
        }
    };

    function submitScore() {
        const inputs = [];
        let zeroCount = 0;
        let totalTwos = 0;

        for (let i = 0; i < 4; i++) {
            const cardInput = document.getElementById(`card-input-${i}`);
            let cards = cardInput.value === '' ? 0 : parseInt(cardInput.value);
            
            if (cards === 0) zeroCount++;
            
            let twos = 0;
            // åªæœ‰å¼€å¯äº†è®¾ç½®æ‰è·å–2çš„æ•°é‡
            if (appState.settings.enableTwos) {
                twos = parseInt(document.getElementById(`twos-val-${i}`)?.value || 0);
            }
            
            // æ ¡éªŒé€»è¾‘ 3ï¼šå•äººæ‰‹é‡Œ2çš„æ•°é‡ä¸èƒ½å¤§äºå‰©ä½™ç‰Œæ•°
            if (twos > cards) {
                alert(`âš ï¸ æ ¡éªŒå¤±è´¥ï¼š\n${appState.players[i].name} åªæœ‰ ${cards} å¼ ç‰Œï¼Œä¸å¯èƒ½æœ‰ ${twos} å¼  2ï¼`);
                return;
            }

            totalTwos += twos;
            inputs.push({ idx: i, cards, twos });
        }

        // æ ¡éªŒé€»è¾‘ 1ï¼šå¿…é¡»æœ‰ä¸€å®¶å‡ºå®Œç‰Œ
        if (zeroCount !== 1) {
            alert("âš ï¸ æ ¡éªŒå¤±è´¥ï¼š\næ¯å±€å¿…é¡»æœ‰ä¸€åï¼ˆä¸”ä»…æœ‰ä¸€åï¼‰ç©å®¶å‡ºå®Œç‰Œï¼ˆ0å¼ ï¼‰ã€‚");
            return;
        }

        // æ ¡éªŒé€»è¾‘ 2ï¼šä¸€å‰¯ç‰Œåªæœ‰4å¼ 2
        if (appState.settings.enableTwos && totalTwos > 4) {
             alert(`âš ï¸ æ ¡éªŒå¤±è´¥ï¼š\næ‰€æœ‰ç©å®¶æ‰‹é‡Œçš„"2"æ€»æ•°ä¸èƒ½è¶…è¿‡4å¼ ï¼(å½“å‰é€‰æ‹©äº†${totalTwos}å¼ )`);
             return;
        }

        const roundRecord = {
            timestamp: Date.now(),
            scores: []
        };

        inputs.forEach(data => {
            const points = calculatePenalty(data.cards, data.twos);
            appState.players[data.idx].score += points;
            roundRecord.scores.push({
                playerId: data.idx,
                cards: data.cards,
                twos: data.twos,
                points: points
            });
        });

        appState.history.push(roundRecord);
        saveState();
        closeModal();
    }

    // --- äº‹ä»¶ç»‘å®š ---
    ui.btnRecord.addEventListener('click', openModal);
    document.getElementById('modal-cancel').addEventListener('click', closeModal);
    document.getElementById('modal-confirm').addEventListener('click', submitScore);

    // å¸®åŠ©å¼¹çª—æ‰“å¼€æ—¶ï¼ŒåŠ¨æ€ç”Ÿæˆå½“å‰URLçš„äºŒç»´ç 
    document.getElementById('btn-help').addEventListener('click', () => {
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.location.href)}`;
        document.getElementById('page-qr').src = qrUrl;
        document.getElementById('help-modal').classList.add('active');
    });

    document.getElementById('btn-settings').addEventListener('click', () => document.getElementById('settings-modal').classList.add('active'));

    // è®¾ç½®ï¼š2çš„åŠ ç½šå¼€å…³
    ui.rule5Toggle.addEventListener('change', (e) => {
        appState.settings.enableTwos = e.target.checked;
        saveState();
    });
    
    // è®¾ç½®ï¼šå…è®¸ä¿®æ”¹åˆ†æ•°å¼€å…³
    ui.editScoreToggle.addEventListener('change', (e) => {
        appState.settings.allowScoreEdit = e.target.checked;
        saveState();
    });

    // è®¾ç½®ï¼šæœ€å¤§åˆ†æ•°è¾“å…¥
    ui.maxScoreInput.addEventListener('change', (e) => {
        const val = parseInt(e.target.value);
        if (isNaN(val) || val <= 0) {
            alert("âŒ åˆ†æ•°çº¿å¿…é¡»ä¸ºæ­£æ•´æ•°ï¼");
            e.target.value = appState.settings.maxScore; // æ¢å¤æ—§å€¼
            return;
        }
        appState.settings.maxScore = val;
        saveState();
    });

    document.getElementById('btn-restart').addEventListener('click', () => {
        if(confirm('ç¡®å®šå¼€å¯æ–°çš„ä¸€ç›˜å—ï¼Ÿ\nå½“å‰åˆ†æ•°å°†æ¸…é›¶ï¼Œä½†åå­—ä¿ç•™ã€‚')) {
            appState.players.forEach(p => p.score = 0);
            appState.history = [];
            saveState();
        }
    });

    document.getElementById('btn-reset-all').addEventListener('click', () => {
        if(confirm('âš ï¸ è­¦å‘Šï¼šè¿™å°†æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬åå­—ï¼‰å¹¶æ¢å¤å‡ºå‚è®¾ç½®ï¼')) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    });

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        });
    }

    render();
</script>
</body>
</html>
